name: Modle Uploader
description: Upload model to model-center bucket of minio
inputs:
  - {name: model_name, description: 'Minio Bucket name'}
  - {name: version, description: 'Minio folder name to upload the files'}
  - {name: filename, description: 'Input file/folder name'}

implementation:
  container:
    image: xiaolao/model-uploader:latest
    command:
    - bash
    - -exc
    - |
      model_path=$0
      handler_path=$1
      model_name=$2
      model_version=$3
      output_model_archive_path=$4

      mkdir -p "$(dirname "$output_model_archive_path")"

      # torch-model-archiver needs the handler to have .py extension
      cp "$handler_path" handler.py
      torch-model-archiver --model-name "$model_name" --version "$model_version" --serialized-file "$model_path" --handler handler.py

      # torch-model-archiver does not allow specifying the output path, but always writes to "${model_name}.<format>"
      expected_model_archive_path="${model_name}.mar"
      mv "$expected_model_archive_path" "$output_model_archive_path"

    args:
      - --model_name
      - {inputValue: model_name}
      - --version
      - {inputValue: version}
      - --filename
      - {inputPath: filename}
